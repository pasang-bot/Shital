#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#define MAX_LEN 50
#define EMAIL_LEN 100

struct user {
    char username[MAX_LEN];
    char email[EMAIL_LEN];
    char password[MAX_LEN];
};
struct Book {
    int id;
    char title[MAX_LEN];
    char author[MAX_LEN];
    int quantity;
};
struct IssuedBook {
    char clientName[MAX_LEN];
    char clientContact[30];
    char clientAddress[200];
    int bookID;
    char title[MAX_LEN];
    char author[MAX_LEN];
    char date[20];
    char returnDate[20];
};
void startMenu();
void registerUser();
void deleteUser();
int logIn();
void menu();
void addBook();
void viewBooks();
void issueBook();
void viewIssuedBooks();
void returnBook();
void editBook();
void searchBook();
void removeBook();
int generateCaptcha();

int main() {
    srand(time(NULL));
    startMenu();
    return 0;
}

void startMenu() {
    int choice;
    while (1) {
        printf("\n===== LOGIN SYSTEM =====\n");
        printf("1. Register\n");
        printf("2. Log In\n");
        printf("3. Delete User Account\n");
        printf("4. Exit\n");
        printf("Enter your choice: ");
        scanf("%d", &choice);
        getchar();
        switch (choice) {
            case 1: registerUser(); break;
            case 2:
                if (logIn()) {
                    printf("\nLogin successful! Welcome to Library System.\n");
                    menu();
                } else {
                    printf("\nLogin failed! Try again.\n");
                }
                break;
            case 3: deleteUser(); break;
            case 4: printf("Exiting program...\n"); exit(0);
            default: printf("Invalid choice! Try again.\n");
        }
    }
}

void registerUser() {
    struct user user, temp;
    int exists = 0;
    char line[300];
    
    printf("\nEnter username: ");
    fgets(user.username, MAX_LEN, stdin);
    user.username[strcspn(user.username, "\n")] = '\0';

    printf("Enter email: ");
    fgets(user.email, EMAIL_LEN, stdin);
    user.email[strcspn(user.email, "\n")] = '\0';

    printf("Enter password: ");
    fgets(user.password, MAX_LEN, stdin);
    user.password[strcspn(user.password, "\n")] = '\0';

    FILE *ufile = fopen("users.txt", "r");
    if (ufile) {
        while (fgets(line, sizeof(line), ufile)) {
            line[strcspn(line, "\n")] = '\0';
            sscanf(line, "%[^\t]\t%[^\t]\t%[^\n]", temp.username, temp.email, temp.password);
            if (strcmp(temp.username, user.username) == 0 || strcmp(temp.email, user.email) == 0) {
                printf("Username or Email already exists!\n");
                exists = 1;
                break;
            }
        }
        fclose(ufile);
    }
    if (exists) return;
    ufile = fopen("users.txt", "a");
    if (!ufile) { printf("Error opening users file.\n"); return; }
    fprintf(ufile, "%s\t%s\t%s\n", user.username, user.email, user.password);
    fclose(ufile);
    printf("User registered successfully!\n");
}

void deleteUser() {
    char username[MAX_LEN], line[300], u[MAX_LEN], e[EMAIL_LEN], p[MAX_LEN];
    int found = 0;
    printf("Enter username to delete: ");
    fgets(username, MAX_LEN, stdin);
    username[strcspn(username, "\n")] = '\0';

    FILE *ufile = fopen("users.txt", "r");
    FILE *temp = fopen("temp.txt", "w");
    if (!ufile || !temp) { printf("Error opening file.\n"); return; }
    while (fgets(line, sizeof(line), ufile)) {
        line[strcspn(line, "\n")] = '\0';
        sscanf(line, "%[^\t]\t%[^\t]\t%[^\n]", u, e, p);
        if (strcmp(u, username) != 0)
            fprintf(temp, "%s\t%s\t%s\n", u, e, p);
        else found = 1;
    }
    fclose(ufile); fclose(temp);
    remove("users.txt"); rename("temp.txt", "users.txt");
    if (found) printf("User deleted successfully.\n");
    else printf("User not found.\n");
}

int generateCaptcha() {
    int a = rand() % 20 + 1;
    int b = rand() % 20 + 1;
    int result = 0, op = rand() % 3;
    switch(op) {
        case 0: printf("\nCAPTCHA: %d + %d = ?\nEnter answer: ", a, b); result = a + b; break;
        case 1: printf("\nCAPTCHA: %d - %d = ?\nEnter answer: ", a, b); result = a - b; break;
        case 2: printf("\nCAPTCHA: %d * %d = ?\nEnter answer: ", a, b); result = a * b; break;
    }
    return result;
}

int logIn() {
    char identifier[MAX_LEN], password[MAX_LEN], line[300];
    struct user user;

    printf("Enter username or email: ");
    fgets(identifier, MAX_LEN, stdin);
    identifier[strcspn(identifier, "\n")] = '\0';

    printf("Enter password: ");
    fgets(password, MAX_LEN, stdin);
    password[strcspn(password, "\n")] = '\0';

    int captcha = generateCaptcha();
    int answer;
    scanf("%d", &answer); getchar();
    if (answer != captcha) { printf("CAPTCHA failed!\n"); return 0; }
    FILE *file = fopen("users.txt", "r");
    if (!file) { printf("No users registered yet.\n"); return 0; }
    while (fgets(line, sizeof(line), file)) {
        line[strcspn(line, "\n")] = '\0';
        sscanf(line, "%[^\t]\t%[^\t]\t%[^\n]", user.username, user.email, user.password);
        if ((strcmp(identifier, user.username) == 0 || strcmp(identifier, user.email) == 0) &&
            strcmp(password, user.password) == 0) {
            fclose(file);
            return 1;
        }
    }
    fclose(file);
    return 0;
}

void menu() {
    int choice;
    while (1) {
        printf("\n<===== Library Management System =====>\n");
        printf("1. Add Book\n");
        printf("2. View Books\n");
        printf("3. Issue Book\n");
        printf("4. View Issued Books\n");
        printf("5. Return Book\n");
        printf("6. Edit Book\n");
        printf("7. Search Book\n");
        printf("8. Remove Book\n");
        printf("9. Logout\n");
        printf("Enter choice: ");
        scanf("%d", &choice);
        getchar();
        switch(choice) {
            case 1: addBook(); break;
            case 2: viewBooks(); break;
            case 3: issueBook(); break;
            case 4: viewIssuedBooks(); break;
            case 5: returnBook(); break;
            case 6: editBook(); break;
            case 7: searchBook(); break;
            case 8: removeBook(); break;
            case 9: printf("Logging out...\n"); return;
            default: printf("Invalid choice.\n");
        }
    }
}

void addBook() {
    struct Book book, tempBook;
    int idExists = 0;
    char line[200];

    printf("Enter Book ID: ");
    scanf("%d", &book.id); getchar();

    FILE *fptr = fopen("library.txt", "r");
    if (fptr) {
        while (fgets(line, sizeof(line), fptr)) {
            sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &tempBook.id, tempBook.title, tempBook.author, &tempBook.quantity);
            if (tempBook.id == book.id) { idExists = 1; break; }
        }
        fclose(fptr);
    }
    if (idExists) { printf("Book ID already exists.\n"); return; }
    
    printf("Enter Book Title: ");
    fgets(book.title, sizeof(book.title), stdin); book.title[strcspn(book.title, "\n")] = '\0';
    printf("Enter Book Author: ");
    fgets(book.author, sizeof(book.author), stdin); book.author[strcspn(book.author, "\n")] = '\0';
    printf("Enter Book Quantity: ");
    scanf("%d", &book.quantity);

    fptr = fopen("library.txt", "a");
    if (!fptr) { printf("Error opening library file.\n"); return; }
    fprintf(fptr, "%d\t%s\t%s\t%d\n", book.id, book.title, book.author, book.quantity);
    fclose(fptr);
    printf("Book added successfully!\n");
}

void viewBooks() {
    struct Book book;
    char line[200];
    FILE *fptr = fopen("library.txt", "r");
    if (!fptr) { printf("No books found.\n"); return; }

    printf("\n%-10s %-20s %-30s %-10s\n", "Book ID", "Title", "Author", "Qty");
    printf("==================================================================\n");
    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &book.id, book.title, book.author, &book.quantity);
        printf("%-10d %-20s %-30s %-10d\n", book.id, book.title, book.author, book.quantity);
    }
    fclose(fptr);
}

void issueBook() {
    struct IssuedBook ib;
    struct Book book;
    int found = 0;
    char line[200], tempFile[] = "temp.txt";
    FILE *fptr = fopen("library.txt", "r");
    FILE *temp = fopen(tempFile, "w");
    if (!fptr || !temp) { printf("Error opening file.\n"); return; }

    printf("Enter Book ID to issue: ");
    scanf("%d", &ib.bookID); getchar();

    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &book.id, book.title, book.author, &book.quantity);
        if (book.id == ib.bookID) {
            if (book.quantity > 0) {
                book.quantity--;
                found = 1;
                strcpy(ib.title, book.title);
                strcpy(ib.author, book.author);

                printf("Enter Client Name: ");
                fgets(ib.clientName, sizeof(ib.clientName), stdin); ib.clientName[strcspn(ib.clientName, "\n")] = '\0';
                printf("Enter Client Contact: ");
                fgets(ib.clientContact, sizeof(ib.clientContact), stdin); ib.clientContact[strcspn(ib.clientContact, "\n")] = '\0';
                printf("Enter Client Address: ");
                fgets(ib.clientAddress, sizeof(ib.clientAddress), stdin); ib.clientAddress[strcspn(ib.clientAddress, "\n")] = '\0';
                time_t t = time(NULL);
                strftime(ib.date, sizeof(ib.date), "%d-%m-%Y %H:%M:%S", localtime(&t));
                FILE *ibfile = fopen("issuedBooks.txt", "a");
                if (ibfile) {
                	
                    fprintf(ibfile, "%s\t%s\t%s\t%d\t%s\t%s\t%s\n", ib.clientName, ib.clientContact, ib.clientAddress, ib.bookID, ib.title, ib.author, ib.date);
                    fclose(ibfile);
                }
            } else printf("Book not available.\n");
        }
        fprintf(temp, "%d\t%s\t%s\t%d\n", book.id, book.title, book.author, book.quantity);
    }
    fclose(fptr); fclose(temp);
    remove("library.txt"); rename(tempFile, "library.txt");
    if (found) printf("Book issued successfully!\n");
    else printf("Book not found.\n");
}

void viewIssuedBooks() {
    struct IssuedBook ib;
    char line[300];
    FILE *fptr = fopen("issuedBooks.txt", "r");
    if (!fptr) { printf("No issued books found.\n"); return; }

    printf("\n%-20s %-15s %-25s %-10s %-20s %-20s %-12s\n", 
           "Client Name", "Contact", "Address", "Book ID", "Title", "Author", "Date");
    printf("============================================================================================================================\n");

    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%[^\t]\t%[^\t]\t%[^\t]\t%d\t%[^\t]\t%[^\t]\t%[^\n]", 
               ib.clientName, ib.clientContact, ib.clientAddress, &ib.bookID, ib.title, ib.author, ib.date);
        printf("%-20s %-15s %-25s %-10d %-20s %-20s %-12s\n", 
               ib.clientName, ib.clientContact, ib.clientAddress, ib.bookID, ib.title, ib.author, ib.date);
    }
    fclose(fptr);
}

void returnBook() {
    struct IssuedBook ib;
    struct Book book;
    char line[300], tempFile[] = "tempIssued.txt";
    int bookID, found = 0;
    char clientName[50];
    printf("Enter Book ID to return: ");
    scanf("%d", &bookID); 
    getchar(); 
    printf("Enter Client Name: ");
    fgets(clientName, sizeof(clientName), stdin);
    clientName[strcspn(clientName, "\n")] = 0;
    FILE *fptr = fopen("issuedBooks.txt", "r");
    FILE *temp = fopen(tempFile, "w");
    if (!fptr || !temp) { 
        printf("Error opening file.\n"); 
        return; 
    }
    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%[^\t]\t%[^\t]\t%[^\t]\t%d\t%[^\t]\t%[^\t]\t%[^\n]", 
               ib.clientName, ib.clientContact, ib.clientAddress, &ib.bookID, ib.title, ib.author, ib.date);
        if (ib.bookID == bookID && strcmp(ib.clientName, clientName) == 0) {
            found = 1;
            time_t t = time(NULL);
            char returnDate[20];
            strftime(returnDate, sizeof(returnDate), "%d-%m-%Y %H:%M:%S", localtime(&t));
            printf("Return Date & Time: %s\n", returnDate);
            FILE *rfile = fopen("returnedBooks.txt", "a");
            if (rfile) {
                fprintf(rfile, "%s\t%s\t%s\t%d\t%s\t%s\t%s\n",
                        ib.clientName, ib.clientContact, ib.clientAddress, ib.bookID,
                        ib.title, ib.author, returnDate);
                fclose(rfile);
            }
            FILE *lib = fopen("library.txt", "r+");
            if (lib) {
                struct Book b;
                char libLine[200];
                long pos;
                while (!feof(lib)) {
                    pos = ftell(lib);
                    if (!fgets(libLine, sizeof(libLine), lib)) break;
                    sscanf(libLine, "%d\t%[^\t]\t%[^\t]\t%d", &b.id, b.title, b.author, &b.quantity);
                    if (b.id == bookID) {
                        b.quantity++;
                        fseek(lib, pos, SEEK_SET);
                        fprintf(lib, "%d\t%s\t%s\t%d\n", b.id, b.title, b.author, b.quantity);
                        break;
                    }
                }
                fclose(lib);
            }

        } else {
            fprintf(temp, "%s", line);
        }
    }
    fclose(fptr); 
    fclose(temp);
    remove("issuedBooks.txt"); 
    rename(tempFile, "issuedBooks.txt");
    if (found) 
        printf("Book returned successfully!\n");
    else 
        printf("Issued book not found for this client and book ID.\n");
}

void editBook() {
    struct Book book;
    char line[200], tempFile[] = "temp.txt";
    int bookID, found = 0;

    printf("Enter Book ID to edit: ");
    scanf("%d", &bookID); getchar();

    FILE *fptr = fopen("library.txt", "r");
    FILE *temp = fopen(tempFile, "w");
    if (!fptr || !temp) { printf("Error opening file.\n"); return; }

    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &book.id, book.title, book.author, &book.quantity);
        if (book.id == bookID) {
            found = 1;
            printf("Enter new Title: ");
            fgets(book.title, sizeof(book.title), stdin); book.title[strcspn(book.title, "\n")] = '\0';
            printf("Enter new Author: ");
            fgets(book.author, sizeof(book.author), stdin); book.author[strcspn(book.author, "\n")] = '\0';
            printf("Enter new Quantity: ");
            scanf("%d", &book.quantity); getchar();
        }
        fprintf(temp, "%d\t%s\t%s\t%d\n", book.id, book.title, book.author, book.quantity);
    }

    fclose(fptr); fclose(temp);
    remove("library.txt"); rename(tempFile, "library.txt");

    if (found) printf("Book edited successfully.\n");
    else printf("Book not found.\n");
}

void searchBook() {
    struct Book book;
    char line[200];
    char keyword[MAX_LEN];
    int found = 0;

    printf("Enter Book Title or Author to search: ");
    fgets(keyword, sizeof(keyword), stdin); keyword[strcspn(keyword, "\n")] = '\0';
    FILE *fptr = fopen("library.txt", "r");
    if (!fptr) { printf("No books found.\n"); return; }

    printf("\n%-10s %-20s %-30s %-10s\n", "Book ID", "Title", "Author", "Qty");
    printf("==================================================================\n");

    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &book.id, book.title, book.author, &book.quantity);
        if (strstr(book.title, keyword) || strstr(book.author, keyword)) {
            found = 1;
            printf("%-10d %-20s %-30s %-10d\n", book.id, book.title, book.author, book.quantity);
        }
    }
    fclose(fptr);
    if (!found) printf("No matching books found.\n");
}

void removeBook() {
    struct Book book;
    char line[200], tempFile[] = "temp.txt";
    int bookID, found = 0;

    printf("Enter Book ID to remove: ");
    scanf("%d", &bookID); getchar();

    FILE *fptr = fopen("library.txt", "r");
    FILE *temp = fopen(tempFile, "w");
    if (!fptr || !temp) { printf("Error opening file.\n"); return; }
    while (fgets(line, sizeof(line), fptr)) {
        sscanf(line, "%d\t%[^\t]\t%[^\t]\t%d", &book.id, book.title, book.author, &book.quantity);
        if (book.id == bookID) found = 1;
        else fprintf(temp, "%d\t%s\t%s\t%d\n", book.id, book.title, book.author, book.quantity);
    }
    fclose(fptr); fclose(temp);
    remove("library.txt"); rename(tempFile, "library.txt");
    if (found) printf("Book removed successfully.\n");
    else printf("Book not found.\n");
}